name: Pull and Deploy
run-name: ${{ github.actor }} is learning Github Actions
on:
  create:
    tags:
      - v*
    branches:
      - main
jobs:
  deploy:
    environment:
      name: prod_secrets
    runs-on: self-hosted
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/fastapisql:v0.1

      - name: Set up Docker Swarm
        run: docker swarm init

      - name: Stop and remove existing containers
        run: docker service rm fast-app || true

      - name: Deploy to Docker Swarm
        run: |
          docker secret create ALGORITHM - <<< "${{secrets.ALGORITHM}}"
          docker secret create ACCESS_TOKEN_EXPIRATION_MINUTES - <<< "${{secrets.ACCESS_TOKEN_EXPIRATION_MINUTES}}"
          docker secret create SECRET_KEY - <<< "${{secrets.SECRET_KEY}}"
          docker secret create DATABASE_USER - <<< "${{secrets.DATABASE_USER}}"
          docker secret create DATABASE - <<< "${{secrets.DATABASE}}"
          docker secret create DATABASE_HOST - <<< "${{secrets.DATABASE_HOST}}"
          docker secret create DATABASE_PORT - <<< "${{secrets.DATABASE_PORT}}"
          docker secret create DATABASE_PASSWORD - <<< "${{secrets.DATABASE_PASSWORD}}"

          docker service create --name fast-app \
            --secret create ALGORITHM \
            --secret create ACCESS_TOKEN_EXPIRATION_MINUTES \
            --secret create SECRET_KEY \
            --secret create DATABASE_USER \
            --secret create DATABASE \
            --secret create DATABASE_HOST \
            --secret create DATABASE_PORT \
            --secret create DATABASE_PASSWORD \
            --env ALGORITHM_FILE=/run/secrets/ALGORITHM \
            --env ACCESS_TOKEN_EXPIRATION_MINUTES_FILE=/run/secrets/ACCESS_TOKEN_EXPIRATION_MINUTES \
            --env SECRET_KEY_FILE=/run/secrets/SECRET_KEY \
            --env DATABASE_USER_FILE=/run/secrets/DATABASE_USER \
            --env DATABASE_FILE=/run/secrets/DATABASE \
            --env DATABASE_HOST_FILE=/run/secrets/DATABASE_HOST \
            --env DATABASE_PORT_FILE=/run/secrets/DATABASE_PORT \
            --env DATABASE_PASSWORD_FILE=/run/secrets/DATABASE_PASSWORD \
            --publish published=8080,target=80 \
            ${{ secrets.DOCKERHUB_USERNAME }}/fastapisql:v0.1

          sleep 10
          docker ps fast-app

      - name: Cleanup Docker Swarm
        run: docker swarm leave --force
